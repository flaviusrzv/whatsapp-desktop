name: Build WhatsApp Desktop for Windows

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  workflow_dispatch:

env:
  NODE_VERSION: '24.13.1'
  ELECTRON_VERSION: '40.6.0'
  APP_NAME: 'WhatsApp'
  BUILD_DIR: 'build/dist'
  RELEASE_DIR: 'build/releases'

jobs:
  build-windows:
    name: Build Windows x64
    runs-on: windows-latest
    timeout-minutes: 30
    
    steps:
      # ==================== SETUP ====================
      
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¦ Setup Yarn
        run: npm install -g yarn@latest
        shell: pwsh
      
      # ==================== DEPENDENCIES ====================
      
      - name: ğŸ”§ Install root dependencies
        run: npm ci --prefer-offline
        shell: pwsh
      
      - name: ğŸ”§ Install app dependencies
        working-directory: ./app
        run: yarn install --frozen-lockfile --prefer-offline
        shell: pwsh
      
      # ==================== VALIDATION ====================
      
      - name: âœ… Verify icon exists
        run: |
          if (!(Test-Path "whatsapp.ico")) {
            Write-Error "Icon file not found: whatsapp.ico"
            exit 1
          }
          Write-Host "âœ“ Icon file verified" -ForegroundColor Green
        shell: pwsh
      
      - name: âœ… Verify app structure
        run: |
          $requiredFiles = @("main.js", "menu.js", "package.json")
          foreach ($file in $requiredFiles) {
            if (!(Test-Path "app/$file")) {
              Write-Error "Required file not found: app/$file"
              exit 1
            }
          }
          Write-Host "âœ“ App structure validated" -ForegroundColor Green
        shell: pwsh
      
      # ==================== BUILD ====================
      
      - name: ğŸ—ï¸ Build Windows application
        run: |
          npx electron-packager ./app ${{ env.APP_NAME }} `
            --overwrite `
            --out=${{ env.BUILD_DIR }} `
            --platform=win32 `
            --arch=x64 `
            --electron-version=${{ env.ELECTRON_VERSION }} `
            --icon=whatsapp.ico `
            --no-asar `
            --app-version=0.6.0 `
            --win32metadata.CompanyName="WhatsApp Desktop" `
            --win32metadata.FileDescription="WhatsApp Desktop Client" `
            --win32metadata.ProductName="WhatsApp Desktop"
        shell: pwsh
      
      - name: âœ… Verify build output
        run: |
          $buildPath = "${{ env.BUILD_DIR }}/${{ env.APP_NAME }}-win32-x64"
          if (!(Test-Path "$buildPath/${{ env.APP_NAME }}.exe")) {
            Write-Error "Build failed: executable not found"
            exit 1
          }
          $size = (Get-Item "$buildPath/${{ env.APP_NAME }}.exe").Length / 1MB
          Write-Host "âœ“ Build successful - Executable size: $([math]::Round($size, 2)) MB" -ForegroundColor Green
        shell: pwsh
      
      # ==================== PACKAGE ====================
      
      - name: ğŸ“¦ Create release package
        run: |
          New-Item -ItemType Directory -Force -Path ${{ env.RELEASE_DIR }} | Out-Null
          
          $sourcePath = "${{ env.BUILD_DIR }}/${{ env.APP_NAME }}-win32-x64/*"
          $zipPath = "${{ env.RELEASE_DIR }}/${{ env.APP_NAME }}-win32-x64-v0.6.0.zip"
          
          Compress-Archive -Path $sourcePath -DestinationPath $zipPath -Force -CompressionLevel Optimal
          
          $zipSize = (Get-Item $zipPath).Length / 1MB
          Write-Host "âœ“ Package created - Size: $([math]::Round($zipSize, 2)) MB" -ForegroundColor Green
        shell: pwsh
      
      # ==================== ARTIFACTS ====================
      
      - name: ğŸ“¤ Upload executable folder
        uses: actions/upload-artifact@v4
        with:
          name: WhatsApp-Desktop-Windows-x64-v0.6.0
          path: ${{ env.BUILD_DIR }}/${{ env.APP_NAME }}-win32-x64/
          if-no-files-found: error
          retention-days: 30
          compression-level: 6
      
      - name: ğŸ“¤ Upload release package
        uses: actions/upload-artifact@v4
        with:
          name: WhatsApp-Desktop-Windows-x64-v0.6.0-ZIP
          path: ${{ env.RELEASE_DIR }}/${{ env.APP_NAME }}-win32-x64-v0.6.0.zip
          if-no-files-found: error
          retention-days: 30
          compression-level: 0
      
      # ==================== SUMMARY ====================
      
      - name: ğŸ“Š Build summary
        if: success()
        run: |
          Write-Host "`nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host "   BUILD SUCCESSFUL" -ForegroundColor Green
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Application: ${{ env.APP_NAME }}" -ForegroundColor White
          Write-Host "Version: 0.6.0" -ForegroundColor White
          Write-Host "Electron: ${{ env.ELECTRON_VERSION }}" -ForegroundColor White
          Write-Host "Node.js: ${{ env.NODE_VERSION }}" -ForegroundColor White
          Write-Host "Platform: Windows x64" -ForegroundColor White
          Write-Host "ASAR: Disabled (folder app/)" -ForegroundColor White
          Write-Host ""
          Write-Host "Artifacts uploaded:" -ForegroundColor Yellow
          Write-Host "  â€¢ WhatsApp-Desktop-Windows-x64-v0.6.0" -ForegroundColor White
          Write-Host "  â€¢ WhatsApp-Desktop-Windows-x64-v0.6.0-ZIP" -ForegroundColor White
          Write-Host ""
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
        shell: pwsh
